---
title: "R Notebook"
output: html_notebook
---

Notebook for aligning and analyzing the 10x samples.

##Sample alignment

```{r}
.libPaths('/home/cbmr/pytrik/libraries/')
setwd('/projects/pytrik/sc_adipose/analyze_10x_fluidigm/')
library(Seurat)
library(magrittr)
```

Prepare the data

```{r}
seurobj_all10x <- readRDS('data/10x-normalized-scaled-clustered-tsne.rds')

samples <- seurobj_all10x@meta.data$sample_name
sample_names <- unique(samples)

list <- list()
variable_genes <- c()

for (i in c(1:14)){
  list[[i]] <- SubsetData(seurobj_all10x, cells.use=seurobj_all10x@cell.names[which(samples %in% sample_names[i])])
  list[[i]] <- FindVariableGenes(list[[i]], do.plot = FALSE)
  variable_genes <- c(variable_genes, rownames(head(list[[i]]@hvg.info, n=1000)))
}

unique.variable_genes <- unique(variable_genes) #4042 genes

```

Performing CCA

```{r}
data <- RunMultiCCA(object.list = list, genes.use=unique.variable_genes, num.ccs=20)
saveRDS(data, 'data/10x-cca.rds')
```

Plot of shared correlation strength per CC to determine the nr of CC's to continue with. Chose to continue with 10 CC's here. 

```{r}
data <- readRDS('data/10x-cca-aligned-tsne-clustered.rds')
MetageneBicorPlot(data, grouping.var = "sample_name", dims.eval = 1:20)
```

Discard cells whose expression profile cannot be well-explained by low-dimensional CCA, compared to low-dimensional PCA. Here cells are discarded when the ratio of the variance explained by CCA is smaller than 0.5 (compared to the variance explained by PCA).

```{r}
data <- CalcVarExpRatio(data, reduction.type = "pca", grouping.var = "sample_name", dims.use = 1:10)
data.all.save <- data
data <- SubsetData(object = data, subset.name = "var.ratio.pca", accept.low = 0.5)
data.discard <- SubsetData(object = data.all.save, subset.name = "var.ratio.pca", accept.high = 0.5)

saveRDS(data.discard, 'data/10x-cca-discardedcells')
data.discard <- readRDS('data/10x-cca-discardedcells')

```

Align the subspaces.

```{r}
data.aligned <- readRDS('data/10x-cca-aligned-tsne-clustered.rds')

data.aligned <- AlignSubspace(data, reduction.type = "cca", grouping.var = "sample_name", dims.align = 1:20)
data.aligned <- RunTSNE(data.aligned, reduction.use = "cca.aligned", dims.use = 1:10)
saveRDS(data.aligned, 'data/10x-cca-aligned-tsne')
```

tSNE plots of the aligned data.

```{r}
data.aligned <- readRDS('data/10x-cca-aligned-tsne')
#head(data.aligned@meta.data)
TSNEPlot(data.aligned, group.by='sample_name', pt.size=0.2)
```

Colored on subtissue.

```{r}
TSNEPlot(data.aligned, group.by='sample_name2', pt.size=0.2)
```

Below the samples are colored based on the clustering performed on the non-aligned data I did earlier. Interesting to see cluster 6 is also captured here.

```{r}
TSNEPlot(data.aligned, group.by='res.0.5', pt.size=0.2)
```

It's the same cluster that can be seen here in the top left (with the mix of peri, subq, supra and visce). This is the tSNE plot of the non-aligned data with pca as dimensionality reduction.

```{r}
data.nonaligned <- readRDS('data/10x-normalized-scaled-clustered.rds')
data.nonaligned <- RunTSNE(data.nonaligned, dims.use=1:12, seed.use=10, perplexity=30, dim.embed=2)

TSNEPlot(data.nonaligned, group.by='sample_name2', pt.size=0.2)
```

```{r}
TSNEPlot(data.nonaligned, group.by='res.0.1', pt.size=0.2)
```

Find marker genes for cluster 6.

```{r}
data.nonaligned <- SetAllIdent(data.nonaligned, id="res.0.1")
data.nonaligned.markers <- FindMarkers(data.nonaligned, ident.1 = 6, min.pct=0.25)
print(x = head(x = data.nonaligned.markers, n=5))
head(data.nonaligned.markers)
```

No marker genes found that are really discriminating for cluster 6. 
Question: I don't understand why the p-value is 0 while the avg_logFC is not really high, and the genes are found in both groups (cluster 6 and the rest). These genes don't discriminate well for cluster 6 then right?

Look at negative avg logFC (don't know if this is interesting to look at?).

```{r}
data.nonaligned.markers <- data.nonaligned.markers[order(data.nonaligned.markers$avg_logFC),]
head(data.nonaligned.markers)
```

```{r}
#Look at difference pct.1 and pct.2
#pct.diff <- data.nonaligned.markers$pct.1 - data.nonaligned.markers$pct.2
#data.nonaligned.markers[match(max(pct.diff), pct.diff),]
#data.nonaligned.markers[match(min(pct.diff), pct.diff),]
```

Look at clusters of the aligned data.

```{r}
data.aligned <- readRDS('data/10x-cca-aligned-tsne-clustered.rds')

data.ccregout <- readRDS('data/10x-normalized-scaled-clustered-ccregout.rds')
ccregout.metadata <- data.frame(row.names=data.ccregout@cell.names[which(data.ccregout@cell.names %in% data.aligned@cell.names)], 
                                Phase=data.ccregout@meta.data$Phase[which(data.ccregout@cell.names %in% data.aligned@cell.names)], 
                                G2M.Score=data.ccregout@meta.data$G2M.Score[which(data.ccregout@cell.names %in% data.aligned@cell.names)], 
                                S.Score=data.ccregout@meta.data$S.Score[which(data.ccregout@cell.names %in% data.aligned@cell.names)])

data.aligned <- AddMetaData(data.aligned, ccregout.metadata)

```

```{r}
TSNEPlot(data.aligned, group.by='res.1', pt.size=0.2)
```

```{r}
TSNEPlot(data.aligned, group.by='Phase', pt.size=0.2)
```

```{r}
#data.aligned <- RunPCA(data.aligned)
data.aligned2 <- RunTSNE(data.aligned, dims.use=1:10, reduction.use='cca.aligned')
data.aligned3 <- RunTSNE(data.aligned, dims.use=1:20, reduction.use='cca.aligned')
TSNEPlot(data.aligned2)
```


##Alignment with cell cycle effects regressed out.

Alignment on data with cell cycle effects regressed out.

```{r}
#seurobj <- readRDS('data/10x-cca-ccregout.rds')
MetageneBicorPlot(seurobj, grouping.var = "sample_name", dims.eval = 1:30) #used 25 cc's for further analysis
```

Check cell cycle effects.

```{r}
aligned.seurobj <- readRDS('data/10x-cca-aligned-ccregout-tsne')
TSNEPlot(aligned.seurobj, group.by='Phase', pt.size=0.1)
```

```{r}
TSNEPlot(aligned.seurobj, group.by='sample_name', pt.size=0.1)
```



```{r}
TSNEPlot(aligned.seurobj, group.by='sample_name2', pt.size=0.1)
```


Check tSNE with less CC's. 

```{r}
#aligned.seurobj2 <- RunTSNE(aligned.seurobj, reduction.use = "cca.aligned", dims.use = 1:10)
TSNEPlot(aligned.seurobj2, group.by='sample_name', pt.size=0.1)
```

